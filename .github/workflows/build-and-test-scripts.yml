name: Build and Test Scripts

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-and-test-linux:
    name: Build and Test (Linux)
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v5
    
    - name: Set up Go
      uses: actions/setup-go@v6
      with:
        go-version-file: 'go.mod'
    
    - name: Make build script executable
      run: chmod +x scripts/build.sh
    
    - name: Build with script - local
      run: ./scripts/build.sh local dev
    
    - name: Make test script executable  
      run: chmod +x scripts/test.sh
    
    - name: Test with script
      run: ./scripts/test.sh
    
    - name: Build with script - all platforms
      run: ./scripts/build.sh all "1.0.0-${{ github.sha }}"
    
    - name: Verify build artifacts
      run: |
        ls -la yaml2env-*
        file yaml2env-linux-amd64
        file yaml2env-linux-arm64
        file yaml2env-windows-amd64.exe
        file yaml2env-windows-arm64.exe
    
    - name: Upload Linux artifacts
      uses: actions/upload-artifact@v5
      with:
        name: yaml2env-linux-builds
        path: |
          yaml2env-linux-amd64
          yaml2env-linux-arm64

  build-and-test-windows:
    name: Build and Test (Windows)
    runs-on: windows-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v5
    
    - name: Set up Go
      uses: actions/setup-go@v6
      with:
        go-version-file: 'go.mod'
    
    - name: Build with PowerShell script - local
      shell: powershell
      run: .\scripts\build.ps1 -Target local -Version dev
    
    - name: Test with PowerShell script
      shell: powershell
      run: .\scripts\test.ps1
    
    - name: Build with PowerShell script - Windows platforms
      shell: powershell
      run: .\scripts\build.ps1 -Target windows -Version "1.0.0-${{ github.sha }}"
    
    - name: Verify build artifacts
      shell: powershell
      run: |
        Get-ChildItem yaml2env-windows-*.exe | Format-Table Name, Length
        
    - name: Upload Windows artifacts
      uses: actions/upload-artifact@v5
      with:
        name: yaml2env-windows-builds
        path: |
          yaml2env-windows-amd64.exe
          yaml2env-windows-arm64.exe

  build-and-test-macos:
    name: Build and Test (macOS)
    runs-on: macos-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v5
    
    - name: Set up Go
      uses: actions/setup-go@v6
      with:
        go-version-file: 'go.mod'
    
    - name: Make build script executable
      run: chmod +x scripts/build.sh
    
    - name: Build with script - local
      run: ./scripts/build.sh local dev
    
    - name: Make test script executable
      run: chmod +x scripts/test.sh
    
    - name: Test with script
      run: ./scripts/test.sh
    
    - name: Verify local build
      run: |
        ls -la yaml2env
        file yaml2env
        ./yaml2env --version

  cross-platform-integration:
    name: Cross-Platform Integration Test
    needs: [build-and-test-linux, build-and-test-windows]
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v5
    
    - name: Download Linux artifacts
      uses: actions/download-artifact@v5
      with:
        name: yaml2env-linux-builds
    
    - name: Download Windows artifacts
      uses: actions/download-artifact@v5
      with:
        name: yaml2env-windows-builds
    
    - name: Test all artifacts exist
      run: |
        echo "Checking all build artifacts are present:"
        ls -la yaml2env-*
        
        # Verify file counts
        LINUX_COUNT=$(ls -1 yaml2env-linux-* 2>/dev/null | wc -l)
        WINDOWS_COUNT=$(ls -1 yaml2env-windows-*.exe 2>/dev/null | wc -l)
        
        echo "Linux builds: $LINUX_COUNT (expected: 2)"
        echo "Windows builds: $WINDOWS_COUNT (expected: 2)"
        
        if [ "$LINUX_COUNT" -ne 2 ]; then
          echo "Error: Expected 2 Linux builds, got $LINUX_COUNT"
          exit 1
        fi
        
        if [ "$WINDOWS_COUNT" -ne 2 ]; then
          echo "Error: Expected 2 Windows builds, got $WINDOWS_COUNT"
          exit 1
        fi
        
        echo "All build artifacts present and accounted for!"
    
    - name: Test Linux AMD64 build
      run: |
        chmod +x yaml2env-linux-amd64
        echo "Testing Linux AMD64 build:"
        ./yaml2env-linux-amd64 --version
        ./yaml2env-linux-amd64 example.yaml --shell bash | head -5
    
    - name: Upload final artifacts
      uses: actions/upload-artifact@v5
      with:
        name: yaml2env-all-platforms
        path: |
          yaml2env-linux-amd64
          yaml2env-linux-arm64
          yaml2env-windows-amd64.exe
          yaml2env-windows-arm64.exe